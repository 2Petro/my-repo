name: Minimal Kernel Build & Release

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install repo tool
        run: |
          sudo apt update
          sudo apt install -y repo git curl zip
          mkdir -p ~/bin
          echo 'export PATH="$HOME/bin:$PATH"' >> ~/.bashrc
          source ~/.bashrc

      - name: Initialize repo
        run: |
          mkdir -p kernel_src
          cd kernel_src
          repo init -u https://github.com/xiaomi-sm8450-kernel/manifest.git \
                    -b zeus-s-oss \
                    --depth=1 \
                    --no-clone-bundle \
                    --no-tags

      - name: Sync kernel + GKI
        run: |
          cd kernel_src
          repo sync \
            --current-branch \
            --no-clone-bundle \
            --no-tags \
            --prune \
            --optimized-fetch \
            --force-sync \
            -j"$(nproc)"

      - name: Remove unnecessary vendor / DLKM directories
        run: |
          cd kernel_src
          rm -rf vendor/* firmware/* device/* prebuilts/* \
                 kernel/vendor* kernel/dlkm* || true

      - name: Remove all .git directories
        run: |
          cd kernel_src
          find . -type d -name ".git" | xargs -r rm -rf || true

      - name: Build kernel (headers + modules)
        run: |
          cd kernel_src
          chmod +x build.sh
          ./build.sh zeus

      - name: Package kernel headers
        run: |
          cd kernel_src/out/msm-kernel-zeus/gki_kernel/common
          zip -r ../../kernel_headers_zeus.zip headers

      - name: Package kernel modules
        run: |
          cd kernel_src/out/msm-kernel-zeus/gki_kernel/common
          find . -name "*.ko" > ko_list.txt
          zip ../../gki_modules_zeus.zip -@ < ko_list.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.0
          name: Zeus Kernel Release
          body: "Compiled GKI kernel modules and headers for Zeus"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            kernel_src/kernel_headers_zeus.zip
            kernel_src/gki_modules_zeus.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
